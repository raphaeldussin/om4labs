# Testing Makefile for OM4labs
# Prior to running, be sure to have installed the package
# by running `pip install .` from the source code directory

domain ?= OM4p125

ifeq ($(domain), OM4p125)
suffix=_d2
extrasect=Windward_Passage.png
endif

ifeq ($(domain), OM4p25)
suffix=
extrasect=
endif


# Outputs generated by the package
HEAT_TRANS_PLOTS = heat_transport.png
MOC_PLOTS = moc_rho.png moc_z.png
SECTION_PLOTS = Agulhas.png Barents_Opening.png Bering_Strait.png Davis_Strait.png \
    Denmark_Strait.png Drake_Passage.png English_Channel.png Faroe-Scotland.png \
    Florida-Bahamas.png Fram_Strait.png Gibraltar_Strait.png Iceland-Faroe.png \
    Iceland-Norway.png Indonesian_Throughflow.png Mozambique_Channel.png \
    Pacific_Equatorial_Undercurrent.png Taiwan-Luzon_Strait.png $(extrasect)
SFC_BIAS_PLOTS = SSS_diff.png SST_diff.png
THETAO_YZ_PLOTS = thetao_yz_gbl_diff.png thetao_yz_atl_diff.png thetao_yz_pac_diff.png
SO_YZ_PLOTS = so_yz_gbl_diff.png so_yz_atl_diff.png so_yz_pac_diff.png

# Combined set of all plots
COMBINED = $(SECTION_PLOTS) $(SFC_BIAS_PLOTS) $(THETAO_YZ_PLOTS) $(SO_YZ_PLOTS) $(MOC_PLOTS) $(HEAT_TRANS_PLOTS)
IMG = $(patsubst %, output/$(domain)/%, $(COMBINED))

all: $(IMG)

test_data/obs:
	curl -o omlabs.obs_data.latest.tar.gz \
	ftp://ftp.gfdl.noaa.gov/perm/John.Krasting/omlabs/omlabs.obs_data.latest.tar.gz
	tar -xzvf omlabs.obs_data.latest.tar.gz

test_data/$(domain):
	curl -o omlabs.$(domain)_test_data.latest.tar.gz \
	ftp://ftp.gfdl.noaa.gov/perm/John.Krasting/omlabs/omlabs.$(domain)_test_data.latest.tar.gz
	tar -xzvf omlabs.$(domain)_test_data.latest.tar.gz

$(patsubst %, output/$(domain)/%, $(HEAT_TRANS_PLOTS)): test_data/$(domain) test_data/obs ../omlabs/diags/heat_transport/heat_transport.py
	omlabs heat_transport --platform testing -o output/$(domain) \
	-s test_data/$(domain)/pp/ocean_monthly$(suffix)/ocean_monthly$(suffix).static.nc \
	test_data/$(domain)/pp/ocean_monthly$(suffix)/av/annual_Xyr/ocean_monthly$(suffix).ann.nc

$(patsubst %, output/$(domain)/%, $(MOC_PLOTS)): test_data/$(domain) ../omlabs/diags/moc/moc.py
	# density plot
	omlabs moc -o output/$(domain) \
	-s test_data/$(domain)/pp/ocean_annual_rho2$(suffix)/ocean_annual_rho2$(suffix).static.nc \
	--topog test_data/$(domain)/pp/ocean_annual_rho2$(suffix)/ocean_annual_rho2$(suffix).static.nc \
	test_data/$(domain)/pp/ocean_annual_rho2$(suffix)/av/annual_Xyr/ocean_annual_rho2$(suffix).ann.nc
	mv output/$(domain)/moc.png output/$(domain)/moc_rho.png

	# z-level plot
	omlabs moc -o output/$(domain) \
	-s test_data/$(domain)/pp/ocean_annual_z$(suffix)/ocean_annual_z$(suffix).static.nc \
	--topog test_data/$(domain)/pp/ocean_annual_z$(suffix)/ocean_annual_z$(suffix).static.nc \
	test_data/$(domain)/pp/ocean_annual_z$(suffix)/av/annual_Xyr/ocean_annual_z$(suffix).ann.nc
	mv output/$(domain)/moc.png output/$(domain)/moc_z.png

$(patsubst %, output/$(domain)/%, $(SECTION_PLOTS)): test_data/$(domain) \
	../omlabs/diags/section_transports/section_transports.py \
	../omlabs/diags/generic_section_transport/generic_section_transport.py
	omlabs section_transports -o output/$(domain) test_data/$(domain)/pp

$(patsubst %, output/$(domain)/%, $(SFC_BIAS_PLOTS)): test_data/$(domain) test_data/obs \
	../omlabs/diags/sst_annual_bias_1x1deg/sst_annual_bias_1x1deg.py \
	../omlabs/diags/sss_annual_bias_1x1deg/sss_annual_bias_1x1deg.py
	omlabs sst_annual_bias_1x1deg --platform testing -o output/$(domain) \
	test_data/$(domain)/pp/ocean_annual_z$(suffix)_1x1deg/av/annual_Xyr/ocean_annual_z$(suffix)_1x1deg.ann.nc
	omlabs sss_annual_bias_1x1deg --platform testing -o output/$(domain) \
	test_data/$(domain)/pp/ocean_annual_z$(suffix)_1x1deg/av/annual_Xyr/ocean_annual_z$(suffix)_1x1deg.ann.nc

$(patsubst %, output/$(domain)/%, $(THETAO_YZ_PLOTS)): test_data/$(domain) test_data/obs \
	../omlabs/diags/generic_yz_annual_bias_1x1deg/generic_yz_annual_bias_1x1deg.py \
	../omlabs/diags/thetao_yz_annual_bias_1x1deg/thetao_yz_annual_bias_1x1deg.py
	omlabs thetao_yz_annual_bias_1x1deg --style diff --platform testing -o output/$(domain) \
	--static test_data/$(domain)/pp/ocean_annual_z$(suffix)_1x1deg/ocean_annual_z$(suffix)_1x1deg.static.nc  \
	test_data/$(domain)/pp/ocean_annual_z$(suffix)_1x1deg/av/annual_Xyr/ocean_annual_z$(suffix)_1x1deg.ann.nc

$(patsubst %, output/$(domain)/%, $(SO_YZ_PLOTS)): test_data/$(domain) test_data/obs \
	../omlabs/diags/generic_yz_annual_bias_1x1deg/generic_yz_annual_bias_1x1deg.py \
	../omlabs/diags/so_yz_annual_bias_1x1deg/so_yz_annual_bias_1x1deg.py
	omlabs so_yz_annual_bias_1x1deg --style diff --platform testing -o output/$(domain) \
	--static test_data/$(domain)/pp/ocean_annual_z$(suffix)_1x1deg/ocean_annual_z$(suffix)_1x1deg.static.nc  \
	test_data/$(domain)/pp/ocean_annual_z$(suffix)_1x1deg/av/annual_Xyr/ocean_annual_z$(suffix)_1x1deg.ann.nc

clean:
	rm -f $(IMG)
	rm -f bilinear*.nc

distclean:
	rm -f bilinear*.nc
	rm -fR test_data
	rm -fR output
	rm -f omlabs.obs_data.latest.tar.gz
	rm -f omlabs.*_test_data.latest.tar.gz
